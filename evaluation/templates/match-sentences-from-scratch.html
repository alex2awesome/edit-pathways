<HTMLQuestion xmlns="http://mechanicalturk.amazonaws.com/AWSMechanicalTurkDataSchemas/2011-11-11/HTMLQuestion.xsd">
<HTMLContent><![CDATA[

<!-- YOUR HTML BEGINS -->
<!DOCTYPE html>
<html>
<head>
<meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
<script type='text/javascript' src='https://s3.amazonaws.com/mturk-public/externalHIT_v1.js'></script>
</head>
<link type="text/css" href="https://getbootstrap.com/1.0.0/assets/css/bootstrap-1.0.0.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://creativecouple.github.io/jquery-timing/jquery-timing.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
<!-- ContextMenu -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.7.1/jquery.contextMenu.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.7.1/jquery.contextMenu.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.7.1/jquery.ui.position.js"></script>

<!-- alertify -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/AlertifyJS/1.13.1/alertify.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/AlertifyJS/1.13.1/css/alertify.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/AlertifyJS/1.13.1/css/themes/bootstrap.min.css">
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/AlertifyJS/1.13.1/css/themes/default.css"> -->

<script src="https://cdn.jsdelivr.net/gh/qiao/difflib.js/dist/difflib-browser.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/gh/musclesoft/jquery-connections/jquery.connections.js"></script>

<style>
.hidden {
    /*transition: opacity 1s ease-out;*/
    /*opacity: 0;*/
    /*height: 0;*/
    /*overflow: hidden;*/
    /*color: white;*/
    visibility: hidden;
}

.example{
    background-color: #efefef;
    margin-left: 20px;
    margin-right: 50px;
    padding: 10px;
    padding-bottom: 1px;
}

.highlighted {
	background-color: yellow;
}

.text-mouseover{
	border-style: solid;
}

#moving_div {
	position: fixed;
	width: 1px;
	height: 1px;
	z-index: -1;
}
.moving_line {
	z-index: -1;
}

/* Handle the question text-boxes */
.textblock {
  border-radius: 4px;
  background: rgba(237, 245, 241, 0.87);
  display: inline-block;
  border: 2px solid Black;
  padding: 5px 10px 5px 10px;
  margin: 10px 10px 10px 10px;
  z-index: 1;
}


.textblock_pool {
	height: 200px;
}

.textblock_span {
	padding-right: 10px;
}

.subset-subj {
	background: #76FF84;
	background-color: #76FF84;
}

/* handle line styles*/
.connection {
	border: 8px double;
    /*border-width: 2.5px;*/
	z-index: 0;
	/*display: table;*/
	border-radius: 100%;
	/*pointer-events:none;*/
	color: rgb(200, 200, 200);
	color: rgba(0, 0, 0, 0.7);
}

.shaded {
	border-color: #55f;
    /*border-radius: 20px;*/
    /*border-width: 5px;*/
}

.dropdown-menu {
    position: absolute;
    z-index: 100;
}


.annotation{
    height: 50%;
}

#submitButton{
    z-index: 5;
}

#feedback{
    width: 100%;
}

hr.hr-medium{
    border: 3px solid black;
}

body{
    margin: 10px !important;
}

/*.hidden{*/
/*    display: none;*/
/*}*/

/* arrows */
.arrow {
  border: solid black;
  border-width: 0 3px 3px 0;
  display: inline-block;
  padding: 3px;
  position: relative;
}

.right {
  transform: rotate(-45deg);
  -webkit-transform: rotate(-45deg);
}

.left {
  transform: rotate(135deg);
  -webkit-transform: rotate(135deg);
}

.up {
  transform: rotate(-135deg);
  -webkit-transform: rotate(-135deg);
}

.down {
  transform: rotate(45deg);
  -webkit-transform: rotate(45deg);
}

</style>
<!-- jquery connections -->
<body>


<form name='mturk_form' method='post' id='mturk_form' action='/mturk/externalSubmit'>
<input type='hidden' value='' name='assignmentId' id='assignmentId'/>

<div class="table table-hover container">
    <div class="row instructions">
        <div class="col-12">
            <div id="accordion">
              <div class="card">
                <div class="card-header" id="hello_header">
                  <h5 class="mb-0">
                    <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#hello">
                      Hello, about us, and thank you for your help!
                    </button>
                  </h5>
                </div>
                <div id="hello" class="collapse show" aria-labelledby="hello_header" data-parent="#accordion">
                  <div class="card-body">
                    Hello! We are small research lab in University of Southern California trying to build AI tools to help
                    citizens better understand the work journalists do.
                    <br><br>
                    We are calibrating our payment scheme <b>to meet a $15 per hour wage and will reward workers who take time
                    to give correct answers</b>.
                    <br><br>
                    If you perform well, we will invite you to participate in future, well-paying trials. If you speed through and give nonsense
                    answers, <b>we will block you and report to Mechanical Turk</b>. We understand the pressures of Mechanical Turk, but we are a
                    small lab and cannot afford to throw out too much data.
                  </div>
                </div>
              </div>
              <div class="card">
                <div class="card-header" id="headingOne">
                  <h5 class="mb-0">
                    <button class="btn btn-link collapsed" data-toggle="collapse" type="button" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                      Instructions
                    </button>
                  </h5>
                </div>
                <div id="collapseTwo" class="collapse" aria-labelledby="headingOne" data-parent="#accordion">
                    <div class="card-body">
                        <h4>Goals and Overview</h4>
                        The goal of this exercise is to help us identify sentences in an article-rewrite that contain substantially new information.

                        Please watch the video or read below to learn how to interact with our interface.
                        <p>
                            <video width="320" height="240" controls>
                              <source src="https://storage.googleapis.com/public-mturk-resources/sped-up.mp4" type="video/mp4">
                            Your browser does not support the video tag.
                            </video>
                        </p>

                        <h4>Steps to completing the task:</h4>
                        <ol>
                            <li>For each sentence in the left-hand column, determine if there is a sentence that conveys substantially the same information on the right.
                                <ul>
                                    <li>By mousing over the sentence block, you will see word-overlaps between the moused-over block and all blocks in the opposite column.
                                        <b>THIS IS MEANT TO BE HELPFUL BUT NOT COMPLETE.</b> Please do not rely on this alone.
                                        We expect that many sentences with high word-overlap still might convey different information.
                                        <i>We will be checking answers for completeness!!</i></li>
                                    <li>If you find two blocks that look very similar but are not exactly the same, ask yourself: is there substantially new information included?
                                        Or is the edit merely cosmetic?</li>
                                </ul>
                            </li>
                            <li>When you find blocks that you think should match - i.e. they contain the same, or substantially similar information - connect them by:
                                (a) right-clicking on the first block and (b) right clicking on it's matching block</li>
                            <li>If you right-click on a block accidentally, you may right-click on the same block to remove the line.</li>
                            <li>Please note, <i>there may be blocks that do not match!!</i> This is OK.</li>
                        </ol>
                    </div>
                </div>
              </div>
              <div class="card">
                <div class="card-header" id="headingOne">
                  <h5 class="mb-0">
                    <button class="btn btn-link collapsed" data-toggle="collapse" type="button" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                      Examples
                    </button>
                  </h5>
                </div>
                <div id="collapseTwo" class="collapse" aria-labelledby="headingOne" data-parent="#accordion">
                    <div class="card-body">
                    </div>
                </div>
              </div>
            </div>
            </div>
        </div>
    <br>
    <hr class="hr-medium">
    <br>
    <h2><u>Task:</u></h2>
    <p><em>Right click and select "Remove" for all connections between sentences that do NOT match.
       <br>Read above for more detailed instructions and examples.</em></p>
    <br>
    <h4>Headline: {{ headline }}</h4>
    <p>Article Key: {{ doc_id }}</p>
    <br>
    <div class="row text" >
        <div class="col-5 textblock_pool_version_x" doc_id="{{ doc_id }}" ></div>
        <div class="col-2 filler" doc_id="{{ doc_id }}" ></div>
        <div class="col-5 textblock_pool_version_y" doc_id="{{ doc_id }}" ></div>
    </div>
    <div class="row annotation">
	    <div class="error question col-4" doc_id="{{ doc_id }}" error_type='error'>
		  <p>
    	  <h4>Does this paragraph have errors?</h4>
    	  <div id="error_btn_grp" class="btn-group-vertical btn-group-toggle" role="group" data-toggle="buttons">
              <div class="btn-group">
                <label class="btn btn-outline-success btn-sm active" label="legit">
                    <input type="radio" name="options" autocomplete="off" checked>No errors</label>
                <label class="btn btn-outline-danger btn-sm" label="incom_sentence">
                 <input type="radio" name="options" autocomplete="off" checked>Incomplete Sentences</label>
              </div>
              <div class="btn-group">
                <label class="btn btn-outline-danger btn-sm" label="other" id="otherbutton">
                    <input type="radio" name="options" autocomplete="off" checked>Other</label>
                <input id="otherform" type="text" class="form-control hidden"
                       aria-label="Text input with radio button" placeholder="Specify...">
              </div>
		  </div>
		  </p>
		</div>
	    <div class="error question col-4" doc_id="{{ doc_id }}" error_type='confidence'>
		  <p>
    	  <h4>How confident are you in this tagging?</h4>
    	  <div class="btn-group-vertical btn-group-toggle" role="group" data-toggle="buttons">
              <div class="btn-group">
                <label class="btn btn-outline-success btn-sm" label="redo">
                    <input type="radio" name="options" autocomplete="off" checked>1 - Needs Redo</label>
                <label class="btn btn-outline-success btn-sm" label="check">
                    <input type="radio" name="options" autocomplete="off" checked>2 - Needs Check</label>
                <label class="btn btn-outline-success btn-sm" label="glance">
                    <input type="radio" name="options" autocomplete="off" checked>3 - Needs Glance</label>
              </div>
              <div class="btn-group">
                <label class="btn btn-outline-success btn-sm active" label="ok">
                    <input type="radio" name="options" autocomplete="off" checked>4 - Should be OK</label>
                <label class="btn btn-outline-success btn-sm" label="perfect">
                    <input type="radio" name="options" autocomplete="off" checked>5 - Confident</label>
              </div>
		  </div>
		 </p>
		</div>
		 </p>
      </div>
    </div>

<div id=moving_div></div> <!-- small div to track with the line. -->
<input type='hidden' value='' name='data' id='data'/>
<div class="container">
    <div class="row">
        <input class="btn btn-outline-success" type='submit' id='submitButton' value='Submit'>
    </div>
<hr>
    <div class="row">
        <div class="col-12">
        <h3>Optional Feedback:</h3>
            <p>
            We'd love to hear some feedback on this task: if any parts were confusing, or the task itself could
            be formulated better, we'd love to hear any comments, ideas or suggestions. We really appreciate your help!
            </p>
        </div>
        <hr>
        <div class="col-12">
            <textarea type='text' value='' name='feedback' id='feedback' placeholder='Optional feedback here...'></textarea>
        </div>
    </div>
</div>
</form>

<script language='Javascript'>

    function get_word_diff_ratio(s_old, s_new) {
        var s_old_words = s_old.split(' ')
        var s_new_words = s_new.split(' ')
        var s = new difflib.SequenceMatcher(null, s_old_words, s_new_words)
        return s.ratio()
    }

    function get_list_diff(l_old, l_new){
        var vars_old = []
        var vars_new = []
        var diffs = difflib.ndiff(l_old, l_new)
        var in_question = false
        diffs.forEach(function(item, idx){
            var label = item[0]
            var text = item.slice(2)
            if (label == '?'){
                return
            }

            else if (label == '-'){
                vars_old.push({
                    'text': text,
                    'tag': '-'
                })
                if (
                        // if something is removed from the old sentence, a '?' will be present in the next idx
                        ((idx < diffs.length - 1) && (diffs[idx + 1][0] == '?'))
                        // if NOTHING is removed from the old sentence, a '?' might still be present in 2 idxs, unless the next sentence is a - as well.
                     || ((idx < diffs.length - 2) && (diffs[idx + 2][0] == '?') && (diffs[idx + 1][0] != '-'))
                ){
                    in_question = true
                    return
                }
                // test if the sentences are substantially similar, but for some reason ndiff marked them as different.
                if ((idx < (diffs.length - 1)) && (diffs[idx + 1][0] == '+')){
                    var text_new = diffs[idx + 1].slice(2)
                    if (get_word_diff_ratio(text, text_new) > .8) {
                        in_question = true
                        return
                    }
                }
                vars_new.push({
                    'text': '',
                    'tag': ' '
                })
            }
            else if (label == '+'){
                vars_new.push({
                    'text': text,
                    'tag': '+'
                })
                if (in_question){
                    in_question = false
                }
                else{
                    vars_old.push({
                        'text':'',
                        'tag': ' '
                    })
                }
            }
            else {
                vars_old.push({
                    'text': text,
                    'tag': ' '
                })
                vars_new.push({
                    'text': text,
                    'tag': ' '
                })
            }
        })
        return [vars_old, vars_new]
    }

    function get_word_diffs(s_old, s_new) {
        var s_old_words = s_old.split(' ')
        var s_new_words = s_new.split(' ')
        return get_list_diff(s_old_words, s_new_words)
    }

    function html_compare_sentences(old_sent, new_sent) {
        var sents = get_word_diffs(old_sent, new_sent)
        old_sent = sents[0]
        new_sent = sents[1]
        var new_html = []
        var old_html = []
        var max_idx = Math.max(old_sent.length, new_sent.length)
        for (var idx = 0; idx < max_idx; idx++) {
            var w_old = old_sent[idx]
            var w_new = new_sent[idx]
            if (w_old['tag'] == '-') {
                old_html.push('<span style="background-color:rgba(255,0,0,0.3)">' + w_old['text'] + '</span>')
            } else {
                old_html.push(w_old['text'])
            }
            if (w_new['tag'] == '+') {
                new_html.push('<span style="background-color:rgba(0,255,0,0.3)">' + w_new['text'] + ' </span>')
            } else {
                new_html.push(w_new['text'])
            }
        }
        return [old_html.join(' '), new_html.join(' ')]
    }

    textblockpool_class_mapper= {
        'x': '.textblock_pool_version_x',
        'y': '.textblock_pool_version_y'
    }

    $('#otherbutton').on('click', function(d){
        $('#otherform').removeClass('hidden')
    })

    $('#otherform').on('click', function(d){
        $('#error_btn_grp').find('label').removeClass('active')
        $('#otherbutton').addClass('active')
    })

    $('#otherbutton2').on('click', function(d){
        $('#otherform2').removeClass('hidden')
    })

    $('#otherform2').on('click', function(d){
        $('#law_type_btn_grp').find('label').removeClass('active')
        $('#otherbutton2').addClass('active')
    })

    var window_height = $( window ).height();
    String.prototype.replaceAll = function(search, replacement) {
        var target = this;
        return target.replace(new RegExp(search, 'g'), replacement);
    };
    String.prototype.toTitleCase = function() {
        var target = this;
        return target.replace(/(?:^|\s)\w/g, function(match) {
            return match.toUpperCase();
        });
    };
    Array.prototype.remove_duplicates = function() {
        var arr = this;
        let s = new Set(arr);
        let it = s.values();
        return Array.from(it);
    };

    (function(old) {
      $.fn.attr = function() {
        if(arguments.length === 0) {
          if(this.length === 0) {
            return null;
          }

          var obj = {};
          $.each(this[0].attributes, function() {
            if(this.specified) {
              obj[this.name] = this.value;
            }
          });
          return obj;
        }

        return old.apply(this, arguments);
      };
    })($.fn.attr);

    function get_arcs(textblock_selector){
        var attrs = $(textblock_selector).attr()
        var arc_attrs = Object.keys(attrs).filter(function(d){return d.indexOf('arc') != -1})
        var line_ids = arc_attrs.map(function(d){ return attrs[d]})
        return line_ids
            .filter(function(d) {return $('.' + d).length != 0 } )
            .sort(function(d1, d2){ return d1.split('-')[1] - d2.split('-')[1]})
    }

     function connection_mouseover(include_shading){
        var left = $(this).attr('left')
        var right = $(this).attr('right')
        var new_html_x = $(this).attr('hidden-html-left')
        var new_html_y = $(this).attr('hidden-html-right')
        // update
        // if (include_shading == true) {
            $(this).addClass('shaded')
        // }
        $('#' + left).addClass('shaded').html(new_html_x)
        $('#' + right).addClass('shaded').html(new_html_y)
    }

    function connection_mouseout(include_shading){
        var left = $(this).attr('left')
        var right = $(this).attr('right')
        var old_html_x = $('#' + left).attr('orig-html')
        var old_html_y = $('#' + right).attr('orig-html')
        // update
        // if (include_shading==true) {
            $(this).removeClass('shaded')
        // }
        $('#' + left).removeClass('shaded').html(old_html_x)
        $('#' + right).removeClass('shaded').html(old_html_y)
    }

    // page handling
    class PageManager {
	constructor(
	    textblock_dim,
        demo,
        check,
        doc_key,
        dropdown_buttons,
        dropdown_arcs,
        textblock_pool_min
	) {
		this.demo = demo
		this.check = check
		this.doc_key = doc_key
		// dropdown buttons
		this.dropdown_buttons = dropdown_buttons
		this.dropdown_arcs = dropdown_arcs
		// dimensions for textblock divs
		this.textblock_pool_min = textblock_pool_min
		this.textblock_dim = textblock_dim;
		this.start_line_id = null
		// z-index for dropdown needs to increase every click :/ maybe not the best implementation
		this.curr_dropdown_zindex = 3
	}

	_get_new_connection_idx(){
	    return $('.connection').length
    }

	_update_node_data_with_new_connection(textblock_x_selector, textblock_y_selector, line_selector){
        // compare diff text for blocks directly connected by a line.
        var x_arcs = get_arcs('#' + textblock_x_selector)
        var y_arcs = get_arcs('#' + textblock_y_selector)
        var x_arc_index = x_arcs.length + 1;
        var y_arc_index = y_arcs.length + 1;
        var text_x = $('#' + textblock_x_selector).attr('orig-text')
        var text_y = $('#' + textblock_y_selector).attr('orig-text')
        var htmls = html_compare_sentences(text_x, text_y)
        var diff_ratio = get_word_diff_ratio(text_x, text_y)
        var html_x = htmls[0]
        var html_y = htmls[1]
        $('.' + line_selector)
				.attr('left', textblock_x_selector)
				.attr('right', textblock_y_selector)
				.attr('doc_id', this.doc_key)
                .attr('hidden-html-left', html_x)
                .attr('hidden-html-right', html_y)
                .attr('word-diff-ratio', diff_ratio)

        // update diff text for all lines leading into a node
        $('#' + textblock_x_selector).attr('arc-' + x_arc_index, line_selector)
        var x_arcs_new = get_arcs('#' + textblock_x_selector)
        x_arcs_new = x_arcs_new
            .sort(function( d1, d2) { return $('.' + d1).attr('right').split('-')[2] - $('.' + d2).attr('right').split('-')[2]})
        var all_y_text_leading_to_x = []
        x_arcs_new.forEach(function(d){
            var node = $('.' + d)
            var y_text = $('#' + node.attr('right')).attr('orig-text')
            all_y_text_leading_to_x.push(y_text)
        })
        htmls = html_compare_sentences(text_x, all_y_text_leading_to_x.join(' '))
        var x_html_all = htmls[0]
        $('#' + textblock_x_selector).attr('html-all', x_html_all)


        $('#' + textblock_y_selector).attr('arc-' + y_arc_index, line_selector)
        var y_arcs_new = get_arcs('#' + textblock_y_selector)
        y_arcs_new = y_arcs_new
            .sort(function( d1, d2) { return $('.' + d1).attr('left').split('-')[2] - $('.' + d2).attr('left').split('-')[2]})
        var all_x_text_leading_to_y = []
        y_arcs_new.forEach(function(d){
            var node = $('.' + d)
            var x_text = $('#' + node.attr('left')).attr('orig-text')
            all_x_text_leading_to_y.push(x_text)
        })
        htmls = html_compare_sentences(all_x_text_leading_to_y.join(' '), text_y)
        var y_html_all = htmls[1]
        $('#' + textblock_y_selector).attr('html-all', y_html_all)
    }

    // create a connection from input data (to re-create datapoints)
    create_static_connection(left_textblock, right_textblock, diff_ratio, class_name){
    	var line_selector = 'line-' + this._get_new_connection_idx()
        var textblock_x_selector = 'sentence-x-' + left_textblock
        var textblock_y_selector = 'sentence-y-' + right_textblock

        //
        $('#' + textblock_x_selector).connections({
			to: '#' + textblock_y_selector,
			class: 'connection hidden ' + line_selector
		})

		// make dropdown
		this._make_right_click_line_dropdown(line_selector, textblock_x_selector, textblock_y_selector)
        this._update_node_data_with_new_connection(textblock_x_selector, textblock_y_selector, line_selector)
        return line_selector
    }

    //
    // handle the right-click dropdown for the line
    _make_right_click_line_dropdown(line_selector, textblock_x_selector, textblock_y_selector){
        var label_left  = $('#' + textblock_x_selector).attr('label')
        var label_right = $('#' + textblock_y_selector).attr('label')

		var that = this
		var menu_options = {}
		var default_options = d3.values(this.dropdown_arcs)
								.map(function(d){return d3.values(d)})
								.flat()
                                .flat()
								.remove_duplicates()
		var options = (this.dropdown_arcs[label_left] || {})[label_right] || default_options
		if (options.length == 1){
			$('.' + line_selector).html(options[0])
		}
		else{
			options.forEach(function(d){menu_options[d] =  {'name': d }})
			menu_options["sep1"] = "---------"
		}
		menu_options['remove'] = {
			name: "Remove",
			icon: function(){ return 'context-menu-icon context-menu-icon-quit';
		}}

		// handle right-click event. (old: if person right-clicks on the line, remove it.)
	    $.contextMenu({
	        selector: '.' + line_selector,
	        callback: function(key, options) {
	        	var this_line = this
	        	$(this_line).html(key)
	        	$(this_line).addClass('line-type-' + key)
	        	$(this_line).attr('label', key)
				$(this_line).css('z-index', 0)
	            if (key == 'remove'){
				  $(this_line).remove();
	            }
	        },
	        items: menu_options,
			hide: function(){
				$(this).css('z-index', 0)
			}
	    });

		$('.' + line_selector).on('contextmenu', function(e){
            $(this).css('z-index', that.curr_dropdown_zindex)
			that.curr_dropdown_zindex = that.curr_dropdown_zindex + 1
        })

		$(document).click(function() {
			$('.connection').css('z-index', 0)
		});
		$(document.body).on("contextmenu:hide",	function(e){
			$('.connection').css('z-index', 0)
		});
    }

    //
    handle_connection(this_div){
	    // this_div
    	// e is the textblock's contextmenu event.
    	var this_class = this
        var exists = $('.moving_line').length
        if (exists){
            if (this_class.start_line_id == this_div.id){
                $('.moving_line').remove()
                return
            }

            if (
                ((this_class.start_line_id.indexOf('x') != -1) && (this_div.id.indexOf('x') != -1)) ||
                ((this_class.start_line_id.indexOf('y') != -1) && (this_div.id.indexOf('y') != -1))
        ){
                alertify.alert('You cannot connect two textblocks from the same column!')
                return
            }

            if (this_class.start_line_id.indexOf('x') != -1){
                var textblock_x_selector = this_class.start_line_id
                var textblock_y_selector = this_div.id
            }
            else{
                var textblock_x_selector = this_div.id
                var textblock_y_selector = this_class.start_line_id
            }
   			var line_selector = 'line-' + this._get_new_connection_idx()

        	// close and make a connection
            // 1. remove floating arrow
            $('.moving_line').remove()
            // 2. make permanent arrow
            $('#' + textblock_x_selector).connections({
				to: '#' + textblock_y_selector,
				class: 'connection annotated ' + line_selector
   			})

   			// 3. make right-click dropdown menu
	        this._make_right_click_line_dropdown(line_selector, textblock_x_selector, textblock_y_selector)
            this._update_node_data_with_new_connection(textblock_x_selector, textblock_y_selector, line_selector)
			// 4. bind data to the line
			$('.' + line_selector)
				.attr('left', textblock_x_selector)
				.attr('right', textblock_y_selector)
				.attr('doc_id', this_class.doc_key)
                .on('mouseover', connection_mouseover)
                .on('mouseout', connection_mouseout)
        } else {
        	// make a floating arrow.
            $(this_div).connections({
                to:'#moving_div',
                class: 'moving_line'
            })
           this.start_line_id = this_div.id
        }
    }

    create_textblock(selected_text, version, block_type, block_id){
    	var that = this
        // create textblock element for the righthand side
        var textblock_pool = $(textblockpool_class_mapper[version]).filter(
            function (d) {
                return $(d).attr('doc_id') == this.doc_key
            }
        )
        // create textblock div
        var textblock_row = document.createElement('div')
        $(textblock_row).addClass('row')
        //
        var textblock_div = document.createElement('div')
        $(textblock_div)
        	.addClass('textblock')
        	.attr('doc_id', that.doc_key)
	       	.attr('id', 'sentence-' + version + '-' + block_id)
	       	.attr('label', block_type)
            .attr('orig-text', selected_text)
            .attr('orig-html', '<span class="textblock_span">' + selected_text + '</span>')
            .attr('html-all', '<span class="textblock_span">' + selected_text + '</span>')

        var textblock_span = document.createElement('span')
        $(textblock_span).addClass('textblock_span')
        textblock_span.textContent = selected_text
        // append elements to the textblock
        $(textblock_div).append(textblock_span)

        if (! this.demo){
            // handle line-drawing
            $(textblock_div).bind('contextmenu', function(e) {
    	        e.preventDefault();
            	that.handle_connection(this)
            })
        }

        // append textblock to the pool of textblocks
        $(textblock_row).append(textblock_div)
    	$(textblock_row).appendTo(textblock_pool)
		$(textblock_div).draggable();
		// dynamically resize the height of the textblock pool
        var multiplier = 2
	    var new_height = d3.sum(
	        textblock_pool.find('.textblock').map(function(i, d){
     			return $(d).height() + multiplier * (
 	    		    that.textblock_dim.margin + that.textblock_dim.border + that.textblock_dim.padding
                ) // 2 * (margin + border + padding)
 		}))
       $(textblock_pool).css('height', d3.max([this.textblock_pool_min, new_height]))
    }
}

    textblock_dims = {
		'margin': 5,
		'border': 2,
		'padding': 10
	}

	textblock_pool_min_height = 200

    buttons = [
		['NODE', 'btn-outline-primary', 'node'],
    ]
    arcs = {
        'NODE': {
            'NODE': [],
        }
    }
    pm = new PageManager(
		textblock_dims, false, false,
		"{{ doc_id }}", buttons, arcs,
		textblock_pool_min_height
	)

    data = JSON.parse('{{ data | tojson | safe }}'.replaceAll('NaN', 'null'))
    versions = data['nodes'].map(function(d){return d['version']})
    x_vers = d3.min(versions)
    y_vers = d3.max(versions)
    var x_nodes = []
    var y_nodes = []
    $(data.nodes).each(function (i, d) {
       if(d.version == x_vers) {
           pm.create_textblock(d.sentence, 'x', 'NODE', d.sent_idx)
           x_nodes.push({
               'sentence': d.sentence,
               'sent_idx': d.sent_idx
           })
       } else {
           pm.create_textblock(d.sentence, 'y', 'NODE', d.sent_idx)
           y_nodes.push({
               'sentence': d.sentence,
               'sent_idx': d.sent_idx
           })
       }
    })

    potential_arcs = []
    for (var i=0; i < x_nodes.length; i++){
        for (var j=0; j < y_nodes.length; j++){
            var diff_ratio = get_word_diff_ratio(x_nodes[i]['sentence'], y_nodes[j]['sentence'])
            potential_arcs.push({
                'sent_idx_x': x_nodes[i]['sent_idx'],
                'sent_idx_y': y_nodes[j]['sent_idx'],
                'diff_ratio': diff_ratio
            })
        }
    }

    $(potential_arcs).each( function(i, d){
        if ((d.sent_idx_x != null ) && (d.sent_idx_y != null)){
            var sel = pm.create_static_connection(d.sent_idx_x, d.sent_idx_y, d.diff_ratio, 'hidden')
            d.line_selector = sel
        }
    })

     // make lines follow the main
     $.repeat().add('connection').each($).connections('update').wait(0);

     // handle floating div
     var $mouseX = 0, $mouseY = 0;
     var $xp = 0, $yp =0;
     $(document).mousemove(function(e){
         $mouseX = e.pageX;
         $mouseY = e.pageY - window.scrollY;
     });

     // handle updating lines on draggable
     var $loop = setInterval(function(){
       $xp += (($mouseX - $xp)/2);
       $yp += (($mouseY - $yp)/2);
       $("#moving_div").css({left:$xp +'px', top:$yp +'px'});
     }, 30);


    // make mouseover highlights for connections and textblocks
    $('.connection')
        .on('mouseover', connection_mouseover)
        .on('mouseout', connection_mouseout)

    $('.textblock')
        .on('mouseover', function(){
            var this_textblock_selector = $(this).attr('id')
            if (this_textblock_selector.indexOf('x') == -1){ // there isn't an x in the side we're currently on
                var other_side = 'left'
            } else{
                var other_side = 'right'
            }

            // update the current node.
            var our_html = $(this).attr('html-all')
            $(this).addClass('shaded').html('<span class="textblock_span">' + our_html + '</span>')

            // update all the nodes on the other side as this node.
            var node_arcs = get_arcs(this)
            node_arcs.forEach(function(d){
                // get other textblock and the html that it should update to.
                var other_textblock = $('.' + d).attr(other_side)
                var other_new_html = $('.' + d).attr('hidden-html-' + other_side)
                // shade the other textblock that the arc connects
                $('#' + other_textblock).addClass('shaded').html(other_new_html)
            })
        })
        .on('mouseout', function(d) {
            //.filter(function(i, d){console.log($(d).attr('class'))})
            // $('.connection')
            //     .filter(function(i, d){return $(d).attr('class').indexOf('annotated') == -1})
            //     .addClass('hidden').each(function(i, d){
            //     $(this).css('opacity', $(this).attr('diff-ratio'))
            // })
            $('.textblock').removeClass('shaded')
            $('.textblock').each(function (i, d) {
                var orig_html = $(d).attr('orig-html')
                $(d).html(orig_html)
            })
        })

    //
    // mturk
    //
    // handle data
    //
    class SubmitHandler{
        constructor() {
            turkSetAssignmentID();
            this.GENERIC_THANKS_MESSAGE = 'Thank you so much for your help with our task!'
            this.completed_checks = false
        }

        _format_data(d, question_class){
            return {
                "doc_id": "{{ doc_id }}",
                "question_class": question_class,
                "sent_idx_x": $('.' + d).attr('left').split('-')[2],
                "sent_idx_y": $('.' + d).attr('right').split('-')[2],
                'version_x': x_vers,
                'version_y': y_vers,
            }
        }

        get_data_from_dom() {
            var that = this
            that.output = {
                'doc_id': "{{ doc_id }}",
                'annotated connections': [],
                'nodes': data.nodes,
                'original_arcs': data.arcs
            }

            var lines_at_end = []
            $('.connection.annotated').each(function (i, d) {
                lines_at_end.push(
                    $(d).attr('class')
                        .split(/\s+/)
                        .filter(function (d) {
                            return d.indexOf('line') != -1
                        })[0]
                )
            })

            // put in this class
            lines_at_end.forEach(function(d){
                that.output['annotated connections'].push(that._format_data(d, 'connections annotated'))
            })
            this.num_lines_added = lines_at_end.length
            this.output['num_connections_added'] = lines_at_end.length
        }

        gather_and_submit_data(submit_button, submit_click_event) {
            this.submit_button = submit_button
            this.submit_click_event = submit_click_event
            this.get_data_from_dom()
            this.first_check() // -> second_confirm -> third_confirm -> submit_data
        }

        first_check(){
            var that = this
            // First question
            alertify.confirm(
                    "You\'ve added " + this.num_lines_added + " lines. Is this correct?",
            ).set('header', '<em>Checking number of connections drawn...</em>')
             .set('labels', {
                        ok: "Continue, submit!",
                        cancel: "Let me recheck..."
                    })
                 .set('onok', function () {
                        that.second_check()
                    })
                 .set('oncancel', function() {
                        alertify.error('Thanks for being diligent! Please recheck and resubmit!')
                    })
        }

        second_check(){
            var that = this
            setTimeout(function() {
                var word_diff_ratios = $('.connection.annotated').map(function (i, d) {
                    return $(d).attr('word-diff-ratio')
                })
                var low_ratios = word_diff_ratios.filter(function (i, d) {return d < .2})
                // Second Question.
                if (low_ratios.length > 0) {
                    alertify.confirm(
                        /* message */ low_ratios.length + " connections have very low word-overlap. Are you sure they are correct?",
                    )
                        .set('header', '<em>Checking all word overlaps...</em>')
                        .set('labels', {
                            ok: "Continue, submit!",
                            cancel: "Let me recheck..."
                        })
                        .set('onok', function () {
                            that.third_confirm()
                        })
                        .set('oncancel', function () {
                            alertify.error('Thanks for being diligent! Please recheck and resubmit!')
                        })
                        // .set('onclose', function () { });
                 // otherwise, skip straight to the final confirm
                } else {
                    that.third_check()
                }
            }, 700)
        }

        third_check(){
            var that = this
            setTimeout(function() {
                alertify.confirm(
                    "Great! Your submission is valid. Do you want to recheck your answers?"
                ).set('header', '<em>Looks good! Ready to Submit?</em>')
                    .set('labels', {
                        ok: "Continue, submit!",
                        cancel: "Let me recheck..."
                    })
                    .set('onok', function () {
                        alertify.success('Ok! Submitting...')
                        alertify.success(that.GENERIC_THANKS_MESSAGE)
                        that.record_data()
                    })
                    .set('oncancel', function () {
                        alertify.error('Thanks for being diligent! Please recheck and resubmit!')
                    })
            }, 700)
        }
        record_data(){
            {% if do_mturk %}
            // submit mturk
            $('#data').attr('value', JSON.stringify(this.output))
            this.completed_checks = true
            $(this.submit_button).trigger(this.submit_click_event.type);
            {% else %}
            // submit AJAX
            this.output['start_time'] = "{{ start_time }}"
            $.ajax({
                url: "/post_task",
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(this.output),
                success: function (result) {
                    if (result === "success") location.href = "/view_task_scratch"
                }
            })
            {% endif %}
        }
    }

    // submit button click
    var sh = new SubmitHandler()
    $('#submitButton').on('click', function(submit_click_event){
        var submit_button = this
        if (! sh.completed_checks) {
            submit_click_event.preventDefault();
            sh.gather_and_submit_data(submit_button, submit_click_event);
        }
    })

</script>
</body></html>
<!-- YOUR HTML ENDS -->

]]>
</HTMLContent>
<FrameHeight>600</FrameHeight>
</HTMLQuestion>